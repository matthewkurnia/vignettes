[gd_scene load_steps=14 format=2]

[ext_resource path="res://game/game.gd" type="Script" id=1]
[ext_resource path="res://test_image.png" type="Texture" id=2]
[ext_resource path="res://game/grain_material.tres" type="Material" id=3]
[ext_resource path="res://player_test.tscn" type="PackedScene" id=4]
[ext_resource path="res://game/main.gd" type="Script" id=5]
[ext_resource path="res://game/particles_viewport.gd" type="Script" id=6]
[ext_resource path="res://game/overlay.gd" type="Script" id=7]
[ext_resource path="res://game/noise.tres" type="Texture" id=8]
[ext_resource path="res://game/background.tscn" type="PackedScene" id=9]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;
render_mode blend_mul;

uniform vec4 color : hint_color;
uniform sampler2D noise_texture;
uniform float contrast = 5.0;

float normalized(float x) {
	return max(min(x, 1.0), 0.0);
}

float get_grain(float x, float a) {
	x += -0.5;
	a += -0.5;
	return normalized(contrast*(x + a) + 0.5);
}

void fragment() {
//	Samples red channel only (black and white)
	float noise = texture(noise_texture, UV).r;
	float value = texture(TEXTURE, UV).r;
	float alpha = get_grain(noise, value);
	COLOR.rgb = clamp(color.rgb + vec3(alpha), vec3(0.0), vec3(1.0));
//	COLOR.a = alpha;
//	COLOR = texture(TEXTURE, UV);
}"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )
shader_param/color = Color( 0.933333, 0.207843, 0.0901961, 1 )
shader_param/contrast = 50.0
shader_param/noise_texture = ExtResource( 8 )

[sub_resource type="Shader" id=3]
code = "shader_type canvas_item;
render_mode blend_mul;

uniform vec4 color : hint_color;
uniform sampler2D noise_texture;
uniform float contrast = 5.0;

float normalized(float x) {
	return max(min(x, 1.0), 0.0);
}

float get_grain(float x, float a) {
	x += -0.5;
	a += -0.5;
	return normalized(contrast*(x + a) + 0.5);
}

void fragment() {
//	Samples red channel only (black and white)
	float noise = texture(noise_texture, UV).r;
	float value = texture(TEXTURE, UV).r;
	float alpha = get_grain(noise, value);
	COLOR.rgb = clamp(color.rgb + vec3(alpha), vec3(0.0), vec3(1.0));
//	COLOR.a = alpha;
//	COLOR = texture(TEXTURE, UV);
}"

[sub_resource type="ShaderMaterial" id=4]
shader = SubResource( 3 )
shader_param/color = Color( 0.0901961, 0.941176, 0.701961, 1 )
shader_param/contrast = 50.0
shader_param/noise_texture = ExtResource( 8 )

[node name="Game" type="Node2D"]
script = ExtResource( 1 )

[node name="WorldRender" type="Node" parent="."]

[node name="Main" type="ViewportContainer" parent="WorldRender"]
material = ExtResource( 3 )
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="MainViewport" type="Viewport" parent="WorldRender/Main"]
size = Vector2( 1920, 1080 )
handle_input_locally = false
disable_3d = true
render_target_update_mode = 3

[node name="Background" parent="WorldRender/Main/MainViewport" instance=ExtResource( 9 )]

[node name="Main" type="CanvasLayer" parent="WorldRender/Main/MainViewport"]
follow_viewport_enable = true

[node name="test_image" type="Sprite" parent="WorldRender/Main/MainViewport/Main"]
visible = false
position = Vector2( 763.472, 517.859 )
texture = ExtResource( 2 )

[node name="PlayerTest" parent="WorldRender/Main/MainViewport" instance=ExtResource( 4 )]
script = ExtResource( 5 )

[node name="Particles" type="ViewportContainer" parent="WorldRender"]
material = SubResource( 2 )
anchor_right = 1.0
anchor_bottom = 1.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ParticlesViewport" type="Viewport" parent="WorldRender/Particles"]
size = Vector2( 1920, 1080 )
handle_input_locally = false
disable_3d = true
usage = 0
render_target_update_mode = 3

[node name="Background" parent="WorldRender/Particles/ParticlesViewport" instance=ExtResource( 9 )]

[node name="Root" type="CanvasLayer" parent="WorldRender/Particles/ParticlesViewport"]
script = ExtResource( 6 )

[node name="Overlay" type="ViewportContainer" parent="WorldRender"]
material = SubResource( 4 )
anchor_right = 1.0
anchor_bottom = 1.0
__meta__ = {
"_edit_use_anchors_": false
}

[node name="OverlayViewport" type="Viewport" parent="WorldRender/Overlay"]
size = Vector2( 1920, 1080 )
handle_input_locally = false
disable_3d = true
usage = 0
render_target_update_mode = 3

[node name="Background" parent="WorldRender/Overlay/OverlayViewport" instance=ExtResource( 9 )]

[node name="Root" type="CanvasLayer" parent="WorldRender/Overlay/OverlayViewport"]
script = ExtResource( 7 )
